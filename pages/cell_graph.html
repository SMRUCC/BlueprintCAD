<!doctype html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <title>Quick Sigma.js Example</title>
    <script src="./js/sigma.min.js"></script>
    <script src="./js/graphology.umd.min.js"></script>
    <script src="./js/graphology-library.min.js"></script>

    <style>
        /* 移除body的默认外边距，让div可以真正占满整个屏幕 */
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            /* 防止因内容超出而出现滚动条 */
        }
    </style>
</head>

<body style="background: lightgrey">
    <div id="container" style="width: 100vw; height: 100vh; background: white"></div>
    <script>
        // 在全局作用域声明变量
        let currentSigmaInstance = null;

        // 这是处理数据的JS函数
        function processLargeData(data) {
            // Create a graphology graph
            const graph = new graphology.Graph();

            console.log("成功接收到数据:", data);
            console.log("成功接收 " + data.length + " 条数据!");

            if (currentSigmaInstance) {
                console.log("正在清除旧的图实例...");

                currentSigmaInstance.kill(); // kill() 方法会清理所有相关资源
                currentSigmaInstance = null; // 清除引用，帮助垃圾回收
            }

            for (let node of data.nodes) {
                graph.addNode(node.id, node);
            }
            for (let edge of data.edges) {
                graph.addEdge(edge.source, edge.target, edge);
            }

            // Instantiate sigma.js and render the graph
            const sigma_graph = new Sigma(graph, document.getElementById("container"));
            // Graphology provides a easy to use implementation of Force Atlas 2 in a web worker
            const sensibleSettings = graphologyLibrary.layoutForceAtlas2.inferSettings(graph);
            const fa2Layout = new graphologyLibrary.FA2Layout(graph, {
                settings: sensibleSettings,
            });

            currentSigmaInstance = sigma_graph;
            currentSigmaInstance.on('clickNode', node => {
                const nodeId = node.node;

                console.log(`节点被点击了！ID: ${nodeId}`);
                // 将节点信息以对象形式发送回宿主程序
                window.chrome.webview.postMessage({ type: 'nodeClicked', nodeId: nodeId });
            });

            fa2Layout.start();
        }

        // 关键步骤：添加消息事件监听器
        window.addEventListener('DOMContentLoaded', () => {
            // 'message' 事件是 WebView2 通信的核心
            window.chrome.webview.addEventListener('message', event => {
                // event.data 就是 VB.NET 发送过来的、已经反序列化好的 JavaScript 对象
                console.log("收到 message 事件:", event);
                processLargeData(event.data);
            });
        });
    </script>
</body>

</html>